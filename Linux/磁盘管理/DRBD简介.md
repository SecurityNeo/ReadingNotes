# DRBD简介 #

DRBD（Distributed Replicated Block Device）：叫做分布式复制块设备，这是一种基于软件，无共享，复制的解决方案。在服务器之间的块设备（包括硬盘、分区、逻辑卷）进行镜像。DRBD是镜像块设备，是按数据位镜像成一样的数据块。DRBD的位置处于文件系统以下，比文件系统更加靠近操作系统内核及IO栈。

## 工作原理 ##

![](img/drbd.png)

客户端发起一个写操作的系统调用给文件系统，写请求再到达内核缓冲区，然后到达DRBD模块，此时drbd会复制写入磁盘的数据，且进行两步操作，第一步操作是调用磁盘驱动，将数据写入本地的磁盘设备，第二部是通过网卡设备将数据发送给备用节点，备用节点的网卡接受到数据之后，将数据再发送给drbd模块，DRBD模块再调用磁盘驱动将数据写入磁盘。

**工作模式**

- 主从模型master/slave（primary/secondary）

	这种模式下，在某一时刻只允许有一个主节点。主节点可以挂载使用，写入数据等；从节点不可以挂载文件系统，因此，也不可以执行读写操作。这种模式可用在任何的文件系统上。默认这种模式下，一旦主节点发生故障，从节点需要手工将资源进行转移，且主节点变成从节点和从节点变成主节点需要手动进行切换。不能自动进行转移，因此比较麻烦。


- 双主模型 dula primary(primary/primary)

	DRBD8.0之后的新特性。所谓双主模型是2个节点都可以当做主节点来挂载使用。在双主模式下，任何资源在任何特定的时间都存在两个主节点。这种模式需要一个共享的集群文件系统，利用分布式的锁机制进行管理，如GFS和OCFS2。部署双主模式时，DRBD可以是负载均衡的集群，这就需要从两个并发的主节点中选取一个首选的访问数据。这种模式默认是禁用的，如果要是用的话必须在配置文件中进行声明。

**同步协议**

- 协议A

	数据在本地完成写操作且数据已经发送到TCP/IP协议栈的队列中，则认为写操作完成。如果本地节点的写操作完成，此时本地节点发生故障，而数据还处在TCP/IP队列中，则数据不会发送到对端节点上。因此，两个节点的数据将不会保持一致。这种协议虽然高效，但是并不能保证数据的可靠性。

- 协议B
 
	数据在本地完成写操作且数据已到达对端节点则认为写操作完成。如果两个节点同时发生故障，即使数据到达对端节点，这种方式同样也会导致在对端节点和本地节点的数据不一致现象，也不具有可靠性。

- 协议C

	只有当本地节点的磁盘和对端节点的磁盘都完成了写操作，才认为写操作完成。这是集群流行的一种方式，应用也是最多的，这种方式虽然不高效，但是最可靠。
