# LVS的工作模式与调度算法 #

## 工作模式 ##

**Virtual Server via Network Address Translation（VS/NAT）**

这个工作模式通过NAT来实现，调度器通过调度算法计算之后，重写数据包的目的IP地址和目的端口，将数据包转发给后端真实服务器；当服务器的响应报文经过调度器时，调度器会重写数据包的源IP地址和源端口，再将数据包发送出去。

调度器处理到来的第一个报文时会在hash表中记录这个连接，当这个连接的下一个数据包过来时，调度器会将数据包发送给同一台后端服务器。LVS采用了标准的TCP状态机（TCP状态机可参考[TCP连接的建立与终止](https://github.com/SecurityNeo/ReadingNotes/blob/master/TCPIP/TCP-IP%E8%AF%A6%E8%A7%A3%E5%8D%B71%E5%8D%8F%E8%AE%AE/%E5%8D%81%E4%B8%80%E3%80%81TCP%E8%BF%9E%E6%8E%A5%E7%9A%84%E5%BB%BA%E7%AB%8B%E4%B8%8E%E7%BB%88%E6%AD%A2.xmind)），当连接终止或者超时后，调度器会将hash表中的这个连接删除。

**Virtual Server via Direct Routing（VS/DR）**

当客户端请求数据包到达LVS时，调度器经过调度算法计算之后，重写数据包的目的MAC地址，再将数据包转发给后端真实服务器；服务器的响应报文会直接发送给客户端。

这种工作方式能极大地提高集群的吞度量。但有几点需要注意：

- 后端服务器组与调度器必须有一个网卡在同一个局域网内；
- 虚IP为调度器与后端服务器组共享；
- 所有后端服务器组需要把虚IP配置在自己的Non-ARP网络设备上，对外不可见，以确保服务器在封装响应报文时源IP仍然为虚IP

**Virtual Server via IP Tunneling（VS/TUN）**

使用VS/NAT模式时，调度器需要重写请求报文的目的IP端口和响应报文的IP端口，同时还需要记录每个连接状态，当请求量很大时，这势必会极大地影响到集群的总体性能。VS/TUN模式能解决这个问题，当请求报文到达调度器时，调度器通过IP隧道将请求报文转发至真实服务器，而真实服务器将响应直接返回给客户，调度器只负责处理请求报文。

IP隧道（IP tunneling）将IP报文封装在另一个IP报文之内，使得目标为一个IP地址的数据报文能被封装和转发到另一个IP地址。IP隧道一般为一个静态通道，但在LVS的架构中，后端是一个服务器组而非一台服务器，不可能静态创建一个一一对应的IP隧道，而是动态地选择一台服务器，将请求报文封装和转发给选出的服务器。

TCP的半连接状态变迁如下：

![半连接状态机](img/TCP.png)

官方三种负载均衡技术比较总结表：

![比较总结](img/LVS.png)


## 调度算法 ##

**轮叫调度（RR）**

轮叫调度算法也叫轮询调度算法，将请求以轮询的方式依次转发给后端的服务器，调度器不会并不会记录当前所有的连接状态，并假设后端服务器的处理能力一致，所有请求被平均分配给后端服务器。

**加权轮叫调度（WRR）**

加权轮询算法算是对轮询调度算法的一种优化，它可以为每一台服务器设置一个加权值，根据服务器处理能力越强，权值越大。调度器按照权值的大小分配请求，权值高的服务器优先收到请求。服务器的缺省权值为1，假设服务器A的权值为1，B的权值为2，则表示服务器B的处理性能是A的两倍。调度器也不会记录当前所有的连接状态，也是一个无状态调度算法。

**最小连接调度（LC）**

最小连接调度是一个有状态调度算法，调度器会记录每台服务器的当前连接数，当有新的请求到达时，调度器会将请求报文转发给当前连接数最小的服务器上，并将对应服务器的连接数加1，当有连接断开或超时时，对应服务器的连接数减1。


**加权最小连接调度（WLC）**

加权最小连接调度算法是最小连接调度的超集，管理员能为每台后端服务器配置一个权值，默认权值为1，调度器在进行请求分配时，尽可能使服务器的已建立连接数和其权值成比例。

**基于局部性的最少链接调度（LBLC）**

基于局部性的最少链接调度算法是针对请求报文的目标IP地址的负载均衡调度，主要用于Cache集群系统，在Cache集群中客户请求报文的目标IP地址是变化的。将相同目标IP地址的请求调度到同一台服务器，可以提高各台服务器的Cache命中率。

LBLC调度算法先根据请求的目的IP地址找出该目的IP地址最近使用的服务器，如果此服务器可用且没有超载，调度器便将请求转发给此服务器；如果服务器不存在，或者该服务器超载且有服务器处于其一半的工作负载，则用“最少链接”的原则选出一个可用的服务器，将请求发送到该服务器。

在此算法里有一个垃圾回收器，它会将过期的目标IP地址到服务器关联项进行回收，过期的关联项是指哪些当前时间（实现时采用系统时钟节拍数jiffies）减去最近使用时间超过设定过期时间的关联项，系统缺省的设定过期时间为24小时。

**带复制的基于局部性最少链接调度（LBLCR）**

与LBLC类似，带复制的基于局部性最少链接调度也是基于目的IP地址进行负载调度，不同的是，LBLC算法维护的是一个目的IP地址到一台服务器的映射关系，而LBLCR维护的是一个目的IP地址到一组服务器的映射。

LBLCR算法先根据请求的目的IP地址找出该目的IP地址对应的服务器组，按“最小连接”原则从该服务器组中选出一台服务器，如果此服务器没有超载，则将请求发送到该服务器，如果服务器超载，则按“最小连接”原则从整个集群中选出一台服务器，并将该服务器加入到服务器组中，同时调度器将请求发送到该服务器。如果该服务器组有一段时间没有被修改，则将最忙的服务器从服务器组中删除，以降低复制的程度。

**目标地址散列调度（DH）**

目标地址散列调度是一种静态调度算法，也是基于目的IP地址进行负载调度。调度器通过散列函数（素数乘法Hash函数）将一个目的IP地址映射到一台服务器。调度器先根据请求的目标IP地址，作为散列键（Hash Key）从静态分配的散列表找出对应的服务器，若该服务器是可用的且未超载，则将请求发送到该服务器，否则返回空。

**源地址散列调度（SH）**

此算法与DH算法正好相反，调度器根据请求的源IP地址，作为散列键（Hash Key）从静态分配的散列表找出对应的服务器，若该服务器是可用的且未超载，将请求发送到该服务器，否则返回空。其采用的算法与DH一致（素数乘法Hash函数）。